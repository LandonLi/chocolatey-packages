name: bbdown

on:
  schedule:
    - cron: "20 0 * * 0"
  workflow_dispatch:

jobs:
  bbdown:
    name: Update BBDown
    runs-on: windows-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4
      - name: Update code by AU
        shell: pwsh
        working-directory: bbdown
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module AU
          ./update.ps1
      - name: Get new version
        id: version
        run: |
          $latestRelease = ((Invoke-WebRequest -Uri "https://api.github.com/repos/nilaoda/BBDown/releases/latest" -UseBasicParsing).Content | ConvertFrom-Json).tag_name
          "latest=$latestRelease" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "BBDown: Update to v${{ steps.version.outputs.latest }}"
          branch: cpr/bbdown/${{ steps.version.outputs.latest }}
          delete-branch: true
          title: "CI: Update BBDown to v${{ steps.version.outputs.latest }}"
          body: |
            Update report
            - Update BBDown to v${{ steps.version.outputs.latest }}
            - Auto-generated by [create-pull-request][1]

            [1]: https://github.com/peter-evans/create-pull-request
          labels: |
            automated
            update version
            BBDown
